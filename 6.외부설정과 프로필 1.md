### 외부설정이란?
하나의 애플리케이션을 여러 다른 환경에서 사용해야 할 때가 있다. 대표적으로 개발이 잘 진행되고 있는지 내부에서 확
인하는 용도의 개발 환경, 그리고 실제 고객에게 서비스하는 운영 환경이 있다.

- 개발 환경: 개발 서버, 개발 DB 사용
- 운영 환경: 운영 서버, 운영 DB 사용


![](https://github.com/woongheo1/Springboot/blob/main/image/%E1%84%89%E1%85%A5%E1%86%AF%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%80%E1%85%A1%E1%86%B9.png)
  
 - 배포 환경과 무관하게 하나의 빌드 결과물을 만든다. 여기서는 `app.jar` 를 빌드한다. 이 안에는 설정값을 두지 않는다.
- 설정값은 실행 시점에 각 환경에 따라 외부에서 주입한다.
    - 개발 서버: `app.jar` 를 실행할 때 `dev.db.com` 값을 외부 설정으로 주입한다.
    - 운영 서버: `app.jar` 를 실행할 때 `prod.db.com` 값을 외부 설정으로 주입한다.

  유지보수하기 좋은 애플리케이션 개발의 가장 기본 원칙은 변하는 것과 변하지 않는 것을 분리하는 것이다.
유지보수하기 좋은 애플리케이션을 개발하는 단순하면서도 중요한 원칙은 변하는 것과 변하지 않는 것을 분리하는 것이다.


### 외부 설정 방식 4가지

- OS 환경변수 
  - 자바프로그램에서만 사용하는것이 아닌 OS 전역에서 사용할수있다는 부분이 불편할수있다.
 
- 자바 시스템 속성
  - 실행 JVM 안에서 접근 가능한 외부설정
  
  - 자바 프로그램 실행시 속성을 줄수있다.
  **java -Durl=dev -jar application.jar**
  
  - 코드 안에서 사용할수있으며, 외부로 설정을 분리하는 효과는 없다. 개발서버, 운영서버에서 각각 다른 jar옵션을 줘서 실행할수있다.

- 자바 커맨드라인 인수
  - **java -jar application.jar A B**
  
  - key, value 형식이 아닌 단순 문자열이기때문에 key,value 형태로 사용하려면 개발자가 직접 파싱해서 값을 집어넣어야한다. 
  
  -  커맨드 라인 옵션 인수(스프링의 제공)
     - **--url=devdb** 와같이 대시 2개로 옵션인수로 구분해 key,value형태로 사용할수있게 해준다. 
  
- 외부파일 (설정 데이터) 
  - 애플리케이션에서 특정 위치의 파일을 읽게끔 해서  설정정보를 읽히게끔 하는것
 
### 커맨드라인 옵션인수와 스프링부트

스프링부트 내부적으로  ApplicationArguments를 빈으로 등록해두고 입력받은 커맨드 라인을 저장해둔다. 

### 외부설정 - 스프링통합
환경변수의 종류를 변경했을때 애플리케이션의 코드를 수정하지않도록 유연하게 사용할수있도록 스프링은 Environment 와 PropertySource로 추상화 해두었다.

![](https://github.com/woongheo1/Springboot/blob/main/image/%E1%84%89%E1%85%B3%E1%84%91%E1%85%B3%E1%84%85%E1%85%B5%E1%86%BC%E1%84%90%E1%85%A9%E1%86%BC%E1%84%92%E1%85%A1%E1%86%B8.png)


### PropertySource

- 로딩시점에 필요한 PropertySource들을 생성해 Environment에서 사용할수있게 연결해둔다.


### Environment

- 특정 외부설정에 종속되지않고 key=value 형식의 외부설정에 접근할수있다. 

- 외부 설정 방식을 변경하더라도 코드변경이 필요없다. 

- 모든 외부설정은 Environment를 통해 조회하면된다.


### 설정데이터 1 - 외부 파일

환경변수가 엄청 많아진다면 프로그램 실행시마다 입력하기 번거롭고 관리도 어려워진다.

대안으로 파일에 저장해서 관리하는 방법이있다.

- 프로그램 외부에 properties 파일을 만들어서 설정값들을 저장해두고 애플리케이션 로딩 시점에 해당파일을 읽게끔 하는 방법 

- 운영, 개발환경에서 각각 다른 properties 파일을 관리해서 사용할수있다.

- 그러나, 서버가 10대라면 10개의 properties 파일을 전부 관리해야한다. 

- 설정값의 변경이력을 확인하기 어렵다. 설정값의 변경과 코드의 변경의 이력을 확인하기 어렵다. 

### 설정데이터 2 - 내부 파일 분리 

- 프로젝트 안에 소스 코드 뿐만 아니라 각 환경에 필요한 설정 데이터도 함께 포함해서 관리한다.
    - 개발용 설정 파일: `application-dev.properties`
    - 운영용 설정 파일: `application-prod.properties`
- 빌드 시점에 개발, 운영 설정 파일을 모두 포함해서 빌드한다.
- `app.jar` 는 개발, 운영 두 설정 파일을 모두 가지고 배포된다.
-  실행할 때 어떤 설정 데이터를 읽어야 할지 최소한의 구분은 필요하다.

### 설정데이터 3- 내부 파일 합체

- ---(yml)나 #--- 로 properties 하나로 구분할수있다.

### 우선순위 - 전체
스프링 부트는 같은 애플리케이션 코드를 유지하면서 다양한 외부 설정을 사용할 수 있도록 지원한다.

**자주 사용하는 우선순위**
- 설정 데이터(`application.properties` )
- OS 환경변수
- 자바 시스템 속성
- 커맨드 라인 옵션 인수
- `@TestPropertySource` (테스트에서 사용)

**설정 데이터 우선순위**
- jar 내부 `application.properties`
- jar 내부 프로필 적용 파일 `application-{profile}.properties`
- jar 외부 `application.properties`
- jar 외부 프로필 적용 파일 `application-{profile}.properties`


**우선순위 이해 방법**

- 더 유연한 것이 우선권을 가진다. (변경하기 어려운 파일 보다 실행시 원하는 값을 줄 수 있는 자바 시스템
속성이 더 우선권을 가진다.)
- 범위가 넒은 것 보다 좁은 것이 우선권을 가진다.
  - OS 환경변수 보다 자바 시스템 속성이 우선권이 있다.
  - 자바 시스템 속성 보다 커맨드 라인 옵션 인수가 우선권이 있다.



















